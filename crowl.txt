Беседа № 129: 
Выбрана Ваша роль: Программист

Понял, тогда вот решение с использованием внедрения зависимостей через конструктор:

package com.example.demo.services;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Service;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.time.LocalDateTime;
import java.time.temporal.ChronoUnit;
import java.util.HashMap;
import java.util.Map;

@Service
public class FolderCleaner {
    private static final Logger logger = LoggerFactory.getLogger(FolderCleaner.class);

    private final Path watchedDirectory;
    private final int daysCount;
    private final Map<Path, LocalDateTime> fileCreationTimes;

    /**
     * Конструктор класса FolderCleaner, в который передаются необходимые параметры.
     *
     * @param directoryPath путь к директории, которую нужно очищать
     * @param daysCount     количество дней, после которых файлы будут удалены
     */
    public FolderCleaner(@Value("${app.directory-path}") String directoryPath,
                        @Value("${app.days-count}") int daysCount) {
        this.watchedDirectory = Paths.get(directoryPath);
        this.daysCount = daysCount;
        this.fileCreationTimes = new HashMap<>();
    }

    /**
     * Метод, выполняющийся каждые 10 минут, который удаляет файлы из папки,
     * созданные более daysCount дней назад.
     */
    @Scheduled(cron = "0 */10 * ? * *")
    public void cleanFolder() {
        try {
            Files.list(watchedDirectory)
                 .forEach(this::deleteExpiredFile);
        } catch (IOException e) {
            logger.error("Ошибка при очистке директории: {}", e.getMessage());
        }
    }

    /**
     * Метод, который проверяет, удаляет ли файл, если он старше daysCount дней.
     *
     * @param path путь к файлу
     */
    private void deleteExpiredFile(Path path) {
        LocalDateTime creationTime = fileCreationTimes.getOrDefault(path, LocalDateTime.now().minusDays(daysCount + 1));
        long daysSinceCreation = ChronoUnit.DAYS.between(creationTime, LocalDateTime.now());

        if (daysSinceCreation > daysCount) {
            try {
                Files.delete(path);
                logger.info("Удален файл {}", path.getFileName());
                fileCreationTimes.remove(path);
            } catch (IOException e) {
                logger.error("Ошибка при удалении файла {}: {}", path.getFileName(), e.getMessage());
            }
        }
    }
}

В этом решении:

1. Параметры directoryPath и daysCount внедряются в конструктор класса с помощью аннотации @Value.
2. Значения для этих параметров должны быть определены в файле конфигурации приложения (например, application.properties или application.yml).

Пример конфигурации:

app.directory-path=/path/to/directory
app.days-count=7

Таким образом, Spring сможет автоматически внедрить необходимые параметры в конструктор FolderCleaner при создании экземпляра этого класса.

2115 из 16384