package com.example.demo.services;

import com.example.demo.configurations.ParametersManager;
import com.example.demo.entities.FileCategory;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Service;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.nio.file.attribute.BasicFileAttributes;
import java.time.Instant;
import java.time.LocalDateTime;
import java.time.ZoneId;
import java.time.temporal.ChronoUnit;
import java.util.Timer;
import java.util.TimerTask;

/**
 * Класс отвечающий за очистку директории с файлами.
 */
@Service
public class FolderCleaner {

    private static final Logger logger = LoggerFactory.getLogger(FolderCleaner.class);

    private final CacheService cacheService;
    private final ParametersManager parametersManager;

    private String watchedDirectoryPath;
    private long cleanerDelay;
    private int daysToExpire;
    private Timer cleanerTimer;

    /**
     * Конструктор класса FolderCleaner.
     * @param cacheService Экземпляр CacheService.
     * @param parametersManager Менеджер параметров для получения обновленных данных.
     */
    public FolderCleaner(CacheService cacheService, ParametersManager parametersManager) {
        this.cacheService = cacheService;
        this.parametersManager = parametersManager;
        startCleaningProcess(); // Запуск процесса очистки
    }

    /**
     * Метод для перезапуска таймера очистки с новыми параметрами.
     */
    public void startCleaningProcess() {
        loadParameters();

        if (cleanerTimer != null) {
            cleanerTimer.cancel();
        }

        cleanerTimer = new Timer("FolderCleanerTimer");

        TimerTask task = new TimerTask() {
            public void run() {
                cleanFolder();
            }
        };

        cleanerTimer.scheduleAtFixedRate(task, 0, cleanerDelay);
    }

    /**
     * Метод для загрузки параметров из ParametersManager.
     */
    public void loadParameters() {
        this.watchedDirectoryPath = parametersManager.getCleanerFolder();
        this.cleanerDelay = parametersManager.getFolderCleanerDelay();
        this.daysToExpire = parametersManager.getDaysToExpire();

        logger.info("Параметры FolderCleaner обновлены: watchedDirectoryPath = {}, cleanerDelay = {}, daysToExpire = {}",
                watchedDirectoryPath, cleanerDelay, daysToExpire);
    }

    /**
     * Метод, который очищает папку от устаревших файлов.
     */
    public void cleanFolder() {
        Path watchedDirectory = Paths.get(watchedDirectoryPath);
        try {
            Files.list(watchedDirectory).forEach(this::deleteExpiredFile);
        } catch (IOException e) {
            logger.error("Ошибка при очистке директории: {}", e.getMessage());
        }
    }

    /**
     * Метод, который удаляет файл, если он старше daysToExpire дней.
     *
     * @param path путь к файлу.
     */
    public void deleteExpiredFile(Path path) {
        String fileName = path.getFileName().toString();
        logger.debug("Обработка файла: {}", fileName);

        String fileExtension = fileName.substring(fileName.lastIndexOf(".") + 1);
        String fileMask = fileName.replaceAll("\\d", "").replace("." + fileExtension, "");

        FileCategory category = cacheService.getCategoryByMaskAndExtension(fileMask + "YYYYMMddHHmm");

        if (category != null) {
            int daysToExpire = category.getDaysToExpire();

            try {
                BasicFileAttributes attrs = Files.readAttributes(path, BasicFileAttributes.class);
                Instant creationInstant = attrs.creationTime().toInstant();
                LocalDateTime creationTime = LocalDateTime.ofInstant(creationInstant, ZoneId.systemDefault());
                long daysSinceCreation = ChronoUnit.DAYS.between(creationTime, LocalDateTime.now());

                if (daysSinceCreation > daysToExpire) {
                    Files.delete(path);
                    logger.info("Удален файл {}", fileName);
                }
            } catch (IOException e) {
                logger.error("Ошибка при удалении файла {}: {}", fileName, e.getMessage());
            }
        }
    }
}






package com.example.demo.configurations;

import com.example.demo.CacheService;
import com.example.demo.entities.Parameters;
import com.example.demo.services.FileMonitor;
import com.example.demo.services.FileValidator;
import com.example.demo.services.FolderCleaner;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.boot.context.event.ApplicationReadyEvent;
import org.springframework.context.event.EventListener;
import org.springframework.stereotype.Component;

import java.util.Timer;
import java.util.TimerTask;

@Component
public class ParametersManager {

    private final CacheService cacheService;
    private final FileMonitor fileMonitor;
    private final FileValidator fileValidator;
    private final FolderCleaner folderCleaner;
    private final Logger logger = LoggerFactory.getLogger(ParametersManager.class);

    private long folderCleanerDelay;
    private String cleanerFolder;
    private int daysToExpire;

    public ParametersManager(
            CacheService cacheService,
            FileMonitor fileMonitor,
            FileValidator fileValidator,
            FolderCleaner folderCleaner) {
        this.cacheService = cacheService;
        this.fileMonitor = fileMonitor;
        this.fileValidator = fileValidator;
        this.folderCleaner = folderCleaner;
    }

    @EventListener(ApplicationReadyEvent.class)
    public void updateParameters() {
        try {
            Parameters parameters = cacheService.getParameters();

            // Обновляем параметры
            updateParameter("folderCleanerDelay", this.folderCleanerDelay, parameters.getFolderCleanerDelay());
            updateParameter("cleanerFolder", this.cleanerFolder, parameters.getCleanerFolder());
            updateParameter("daysToExpire", this.daysToExpire, parameters.getDaysToExpire());

            // Перезапуск FolderCleaner с новыми параметрами
            folderCleaner.startCleaningProcess();

            TimerTask task = new TimerTask() {
                public void run() {
                    updateParameters();
                }
            };
            Timer timer = new Timer("ParameterUpdateTimer");
            timer.schedule(task, parameters.getRefreshRate());
        } catch (Exception e) {
            logger.error("Ошибка при обновлении параметров: ", e);
        }
    }

    private void updateParameter(String paramName, Object oldValue, Object newValue) {
        if (!oldValue.equals(newValue)) {
            logger.info("Параметр {} изменен: {} -> {}", paramName, oldValue, newValue);
        }
    }

    public String getCleanerFolder() {
        return cleanerFolder;
    }

    public long getFolderCleanerDelay() {
        return folderCleanerDelay;
    }

    public int getDaysToExpire() {
        return daysToExpire;
    }
}

