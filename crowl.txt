package ru.sberinsur.fileImporter.services;

import org.springframework.stereotype.Service;

import java.util.concurrent.ConcurrentHashMap;
import java.util.Map;

@Service
public class ProgressBarService {

    private final Map<String, ProgressBar> progressBars = new ConcurrentHashMap<>();

    public void startProgress(String fileName, long totalRecords, int batchSize) {
        int totalSteps = (int) Math.ceil((double) totalRecords / batchSize);
        progressBars.put(fileName, new ProgressBar(totalSteps, fileName));
        System.out.println("Начало прогресса для файла: " + fileName);
    }

    public void updateProgress(String fileName, int stepsCompleted) {
        ProgressBar progressBar = progressBars.get(fileName);
        if (progressBar != null) {
            progressBar.update(stepsCompleted);
        }
    }

    public void completeProgress(String fileName) {
        ProgressBar progressBar = progressBars.get(fileName);
        if (progressBar != null) {
            progressBar.complete();
        }
        progressBars.remove(fileName);
        System.out.println("Прогресс завершён для файла: " + fileName);
    }

    private static class ProgressBar {
        private final int totalSteps;
        private int completedSteps;
        private final String fileName;

        public ProgressBar(int totalSteps, String fileName) {
            this.totalSteps = totalSteps;
            this.fileName = fileName;
            this.completedSteps = 0;
        }

        public synchronized void update(int steps) {
            completedSteps = Math.min(completedSteps + steps, totalSteps);
            printProgress();
        }

        public synchronized void complete() {
            completedSteps = totalSteps;
            printProgress();
            System.out.println(); // Закрываем строку после завершения.
        }

        private void printProgress() {
            int percentage = (int) ((double) completedSteps / totalSteps * 100);
            int progressBars = (int) ((double) percentage / 2); // 50 символов = 100%

            StringBuilder progressBar = new StringBuilder("[");
            for (int i = 0; i < 50; i++) {
                if (i < progressBars) {
                    progressBar.append("=");
                } else {
                    progressBar.append(" ");
                }
            }
            progressBar.append("] ").append(percentage).append("%");

            // Перезаписываем строку в консоли
            System.out.print("\rПрогресс для файла " + fileName + ": " + progressBar);
            System.out.flush();
        }
    }
}
